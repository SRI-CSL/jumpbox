= JumpBox Design =

This document details the design of the Jumpbox which is a combination of a C-based daemon (djb)
and a browser plugin.

== Authors ==

 Ian Mason	SRI International	 <ian.mason@sri.com>
 Jeroen Massar 	Farsight Security, Inc.	 <massar@fsi.io>

== Javascript details ==

Details about the current Javascript (plugin) implementation are to be found in:
 plugin/chrome/background.js
which contains an introduction on how these requests work

== Jump Box API ==

djb (Jumpbox server) provides a webinterface at http://localhost:6543.

=== Proxy requests ===

StegoTorus sends requests to http://<something>/<url> using djb as a HTTP proxy (at localhost:6543).
As requests landing at djb are not pointing at http://localhost djb knows these are requests not for djb
but those that it needs to proxy. This avoids the need to modify any HTTP client (like StegoTorus) using this setup.

As we listen on localhost we do not have to worry (too much) that other clients use our HTTP proxy.

djb accepts the request from StegoTorus and forwards this to plugins that requests next packets.

==== Proxy Pull ====

For requesting a packet from djb we have a 'pull' request (GET http://localhost:6543/pull/). 

When that URL is hit, djb returns content of the Stegotorus Client's request with the following
additional headers:

* DJB-URI: <URI of the Stegotorus Request>
* DJB-Method: <HTTP Method of Stegotorus Request>
* DJB-Content-Type: <Content-Type of StegoTorus Request> (opt)
* DJB-Cookie: <this should be *instead of* any cookie header in the Stegotorus Client request> (opt)
* DJB-SeqNo: Packet Sequence Number (assigned by djb)

At this point the request is forwarded by the plugin, when it receives an answer it pushes the answer
to djb using a 'push' request.

==== Proxy Push ====

The plugin can return data using a 'POST http://localhost:6543/push/' along with the following headers:

* DJB-Set-Cookie: <Cookie for this request> (opt)
* DJB-SeqNo: Packet Sequence Number (assigned by djb)

The SeqNo is used to match this 'answer' up to the actual request, so that we can pass it to the right
StegoTorus client (there might be multiple).

The DJB-Set-Cookie header is translated into a Set-Cookie to allow this header to be forwarded by the plugin.

=== ACS ===

ACS has two phases for the consideration of this document: initial + redirect.
The third phase 'bridge' is performed by providing the NET details to StegoTorus and starting it.

==== ACS Initial ====
==== ACS Redirect ====

=== djb HTTP Errors ===

djb reports errors using standard HTTP errorcodes, As a reference, some are listed here:

200 = All okay

404 = Not Found, when something cannot be found (eg a push, but the corresponding pull cannot be found)

408 = Request Timeout, typically for 'pull' when for a long time no request needed to be sent.
      The plugin can retry the request at a later point.

504 = Parameter missing

